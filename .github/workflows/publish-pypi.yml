name: Publish python package
on:
  push:
    tags:
      - "*.*.*"
jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Assert tag is from default branch
        run: |
          set -euo pipefail

          default_branch="${{ github.event.repository.default_branch }}"
          tag_commit="$(git rev-list -n 1 "${GITHUB_REF_NAME}")"

          git fetch --no-tags origin "${default_branch}:${default_branch}"
          git merge-base --is-ancestor "${tag_commit}" "${default_branch}"

          echo "Tag commit ${tag_commit} is reachable from ${default_branch}"
      - name: Build and publish to pypi
        uses: JRubics/poetry-publish@v1.8
        with:
          pypi_token: ${{ secrets.PYPI_TOKEN }}
